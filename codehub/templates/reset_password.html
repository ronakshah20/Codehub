{% extends "base.html" %}
{% load static %}

{% block title %}CodeHub - Set New Password{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'auth.css' %}"/>
{% endblock %}

{% block content %}
<div class="auth-card">
    <h2>Set your new password</h2>
    <p class="auth-subtitle">
        Your code was verified. Please enter a new password for your account.
    </p>

    <div id="feedback-message" style="display:none; margin-bottom: 1rem;"></div>

    <form id="reset-password-form" method="POST">
        {% csrf_token %}
        
        <input type="password" id="new-password" name="new_password" placeholder="Enter new password" class="form-input" required>
        <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm new password" class="form-input" required>

        <button type="submit" id="reset-btn" class="btn-primary">
            Reset Password
        </button>
    </form>
    
    <p class="auth-prompt">
        <a href="{% url 'login' %}">Back to Login</a>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('reset-password-form');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const resetButton = document.getElementById('reset-btn');
    const feedbackMessage = document.getElementById('feedback-message');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener('submit', (e) => {
        e.preventDefault(); // Stop the form from submitting normally

        // Basic frontend check for matching passwords
        if (newPasswordInput.value !== confirmPasswordInput.value) {
            feedbackMessage.textContent = 'Passwords do not match.';
            feedbackMessage.style.color = '#ff5252';
            feedbackMessage.style.display = 'block';
            return; // Stop here
        }

        resetButton.disabled = true;
        resetButton.textContent = 'Saving...';
        feedbackMessage.style.display = 'none';

        fetch("{% url 'finalize_reset' %}", { // This is our API URL from File 1
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `new_password=${encodeURIComponent(newPasswordInput.value)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success! Redirect to the login page as specified by the server.
                feedbackMessage.textContent = 'Password reset successfully! Redirecting to login...';
                feedbackMessage.style.color = '#28a745'; // Green for success
                feedbackMessage.style.display = 'block';

                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000); // Wait 2 seconds before redirecting
            } else {
                // Show the error message from the server
                feedbackMessage.textContent = data.message;
                feedbackMessage.style.color = '#ff5252';
                feedbackMessage.style.display = 'block';
                resetButton.disabled = false;
                resetButton.textContent = 'Reset Password';
            }
        })
        .catch(error => {
            feedbackMessage.textContent = 'A network error occurred. Please try again.';
            feedbackMessage.style.color = '#ff5252';
            feedbackMessage.style.display = 'block';
            resetButton.disabled = false;
            resetButton.textContent = 'Reset Password';
        });
    });
});
</script>
{% endblock %}