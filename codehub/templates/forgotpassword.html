{% extends "base.html" %}
{% load static %}

{% block title %}CodeHub - Forgot Password{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'auth.css' %}"/>
{% endblock %}

{% block content %}
<div class="auth-card">
    <h2>Reset your password</h2>
    <p class="auth-subtitle">Enter your registered email to receive an OTP code.</p>

    <div id="feedback-message" style="display:none; margin-bottom: 1rem;"></div>

    <form id="password-reset-form" method="POST">
        {% csrf_token %}
        <input type="email" id="email-for-reset" name="email" placeholder="Enter your email" class="form-input" required>
        
        <button type="submit" id="send-otp-btn" class="btn-primary">
            Send Code
        </button>
    </form>
    
    <p class="auth-prompt">
        Remembered your password?
        <a href="{% url 'login' %}">Back to Login</a>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('password-reset-form');
    const emailInput = document.getElementById('email-for-reset');
    const sendButton = document.getElementById('send-otp-btn');
    const feedbackMessage = document.getElementById('feedback-message');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener('submit', (e) => {
        e.preventDefault(); // Stop the form from submitting normally
        
        sendButton.disabled = true;
        sendButton.textContent = 'Sending...';
        feedbackMessage.style.display = 'none';

        fetch("{% url 'send_otp' %}", { // This is our API URL from File 1
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `email=${encodeURIComponent(emailInput.value)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success! Redirect to the URL our server sent
                window.location.href = data.redirect_url;
            } else {
                // Show the error message from the server
                feedbackMessage.textContent = data.message;
                feedbackMessage.style.color = '#ff5252'; // Red color for error
                feedbackMessage.style.display = 'block';
                sendButton.disabled = false;
                sendButton.textContent = 'Send Code';
            }
        })
        .catch(error => {
            feedbackMessage.textContent = 'A network error occurred. Please try again.';
            feedbackMessage.style.color = '#ff5252';
            feedbackMessage.style.display = 'block';
            sendButton.disabled = false;
            sendButton.textContent = 'Send Code';
        });
    });
});
</script>
{% endblock %}